package com.cg.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;

import com.cg.model.Appointment;
import com.cg.model.Patient;
import com.cg.model.User;
import com.cg.service.PatientService;
import com.cg.service.UserService;

public class PatientController {

    @Autowired
    private PatientService patientService;

    // Get the loggedâ€‘in patient using username
    private Patient getCurrentPatient(UserDetails userDetails) {
        return patientService.findByUsername(userDetails.getUsername());
    }

    // ---------------- BOOK APPOINTMENT ----------------
    @GetMapping("/book-appointment")
    public String bookAppointmentPage(Model model) {
        model.addAttribute("appointment", new Appointment());
        return "hospital/patient-book-appointment";
    }

    @PostMapping("/book-appointment")
    public String saveAppointment(@ModelAttribute Appointment appointment,
                                  @AuthenticationPrincipal UserDetails userDetails) {

        Patient patient = getCurrentPatient(userDetails);
        appointment.setPatient(patient);
        appointmentService.save(appointment);
        return "redirect:/patient/appointments";
    }

    // ---------------- VIEW APPOINTMENTS ----------------
    @GetMapping("/appointments")
    public String myAppointments(@AuthenticationPrincipal UserDetails userDetails, Model model) {
        Patient patient = getCurrentPatient(userDetails);
        model.addAttribute("appointments", patient.getAppointments());
        return "hospital/patient-appointments";
    }

    // ---------------- MEDICAL RECORDS ----------------
    @GetMapping("/records")
    public String medicalRecords(@AuthenticationPrincipal UserDetails userDetails, Model model) {
        Patient patient = getCurrentPatient(userDetails);
        model.addAttribute("records", patient.getMedicalRecords());
        return "hospital/patient-records";
    }

    // ---------------- BILLS ----------------
    @GetMapping("/bills")
    public String myBills(@AuthenticationPrincipal UserDetails userDetails, Model model) {
        Patient patient = getCurrentPatient(userDetails);
        model.addAttribute("bills", patient.getBills());
        return "hospital/patient-bills";
    }
}
